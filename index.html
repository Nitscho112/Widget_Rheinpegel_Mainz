<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rhein in Mainz – Pegel</title>
<meta http-equiv="Cache-Control" content="no-store" />
<style>
  :root{
    --bg:#2a2d32;
    --card:#2a2d32;
    --fg:#e7e9ee;
    --muted:#a0a6b3;

    --wave1:#3b82f6;   /* oben (sanft) */
    --wave2:#1e3a8a;   /* unten */

    --up:#dc2626;      /* Rot = steigend */
    --flat:#9aa3af;    /* Grau = gleichbleibend */
    --down:#16a34a;    /* Grün = fallend */
  }

  *{box-sizing:border-box}
  html,body{
    height:100%; width:100%;
    margin:0; padding:0;
    background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  .card{
    width:100%; height:100%;
    background:var(--card);
    border:none; border-radius:0; box-shadow:none;
    overflow:hidden; display:flex; flex-direction:column;
  }

  .hero{ position:relative; height:280px; background:var(--card); flex:0 0 auto; }

  .wave{ position:absolute; left:0; right:0; height:105px; overflow:hidden; pointer-events:none; }
  .wave.top{ top:0; transform:rotate(180deg); opacity:.6 }
  .wave.bot{ bottom:0; opacity:.6 }
  .wave svg{ width:200%; height:100%; display:block }
  .mover{ animation:slide 14s linear infinite }
  .mover.slow{ animation-duration:20s }
  @keyframes slide { from{ transform:translateX(0) } to{ transform:translateX(-50%) } }

  .center{
    position:absolute; left:0; right:0;
    top:120px; bottom:120px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:10px; text-align:center;
  }
  .place{
    font-size:22px; font-weight:800; letter-spacing:.25px;
    background:rgba(0,0,0,.35); padding:4px 12px; border-radius:12px;
    text-shadow:0 2px 6px rgba(0,0,0,.4); white-space:nowrap;
  }
  .value{ font-size:96px; font-weight:900; line-height:1; letter-spacing:.5px }
  .unit{ font-size:24px; margin-left:8px; opacity:.95 }

  .inner{
    flex:1 1 auto; display:flex; flex-direction:column; align-items:center; text-align:center;
    padding:16px 12px 18px; gap:10px;
  }
  .curr{ font-size:16px; color:var(--muted) }

  .trend{
    display:flex; align-items:center; justify-content:center; gap:12px;
    font-size:22px; font-weight:800; flex-wrap:wrap;
  }
  .trend svg{ width:40px; height:40px; display:block }
  .note{ font-size:13px; color:var(--muted); margin-top:4px }
  .err{ color:#fecaca; min-height:1.2em; font-size:14px; text-align:center }

  @media (max-width:480px){
    .hero{ height:260px }
    .center{ top:110px; bottom:110px }
    .value{ font-size:74px }
    .trend svg{ width:34px; height:34px }
  }
</style>
</head>
<body>
  <div class="card" role="group" aria-label="Pegel Rhein in Mainz">
    <div class="hero">
      <!-- sanftere obere Welle -->
      <div class="wave top" aria-hidden="true">
        <svg viewBox="0 0 1200 100" preserveAspectRatio="none">
          <g class="mover">
            <path fill="var(--wave1)" d="M0 50c120 15 240-15 360 0s240 15 360 0 240-15 360 0 240 15 360 0v50H0z"/>
            <path fill="var(--wave1)" transform="translate(1200,0)" d="M0 50c120 15 240-15 360 0s240 15 360 0 240-15 360 0 240 15 360 0v50H0z"/>
          </g>
        </svg>
      </div>
      <!-- untere Welle -->
      <div class="wave bot" aria-hidden="true">
        <svg viewBox="0 0 1200 100" preserveAspectRatio="none">
          <g class="mover slow">
            <path fill="var(--wave2)" d="M0 60c120 20 240-20 360 0s240 20 360 0 240-20 360 0 240 20 360 0v40H0z"/>
            <path fill="var(--wave2)" transform="translate(1200,0)" d="M0 60c120 20 240-20 360 0s240 20 360 0 240-20 360 0 240 20 360 0v40H0z"/>
          </g>
        </svg>
      </div>

      <!-- Titel + Zahl zwischen den Wellen -->
      <div class="center">
        <div class="place" id="place">RHEIN in MAINZ</div>
        <div><span class="value" id="value">--</span><span class="unit">cm</span></div>
      </div>
    </div>

    <div class="inner">
      <div class="curr" id="curr">Zuletzt gemessen: —</div>
      <div class="trend" id="trend" title="Tendenz"><span class="label">Tendenz:</span></div>
      <div class="note">aus den letzten 10 Messungen</div>
      <div class="err" id="err" aria-live="polite"></div>
    </div>
  </div>

<script>
  const UUID = "a37a9aa3-45e9-4d90-9df6-109f3a28a5af"; // Mainz
  const BASE = "https://www.pegelonline.wsv.de/webservices/rest-api/v2";
  const LAST_N = 10; // Tendenz nur über die letzten N Messungen

  const elPlace = document.getElementById("place");
  const elValue = document.getElementById("value");
  const elCurr  = document.getElementById("curr");
  const elTrend = document.getElementById("trend");
  const elErr   = document.getElementById("err");

  const THRESH = 0.5; // cm/h – Klassengrenze (steigend/fallend vs. gleichbleibend)

  const fmtDateTime = (iso) => new Intl.DateTimeFormat("de-DE", {
    timeZone: "Europe/Berlin", dateStyle: "short", timeStyle: "short"
  }).format(new Date(iso));

  async function j(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error(r.status+" "+r.statusText);
    return r.json();
  }

  // Regression → cm/h
  function slopePerHour(points){
    if(points.length < 2) return 0;
    const t0 = points[0].t;
    const xs = points.map(p => (p.t - t0)/3600_000);
    const ys = points.map(p => p.v);
    const mean = a => a.reduce((x,y)=>x+y,0)/a.length;
    const mx = mean(xs), my = mean(ys);
    let num=0, den=0;
    for(let i=0;i<xs.length;i++){ const dx=xs[i]-mx, dy=ys[i]-my; num += dx*dy; den += dx*dx; }
    return den===0 ? 0 : num/den;
  }

  function trendIcon(slope){
    if (slope > THRESH)   return {name:"steigend", color:"var(--up)",
      svg:'<path d="M14 24V4M14 4l7 7M14 4l-7 7" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>'};
    if (slope < -THRESH)  return {name:"fallend",  color:"var(--down)",
      svg:'<path d="M14 4v20M14 24l7-7M14 24l-7-7" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>'};
    return {name:"gleichbleibend", color:"var(--flat)",
      svg:'<text x="14" y="24" text-anchor="middle" font-size="24" fill="currentColor">≈</text>'};
  }

  async function load(){
    elErr.textContent = "";
    try{
      const station = await j(`${BASE}/stations/${UUID}.json`);
      elPlace.textContent = `${station.water?.longname || "RHEIN"} in ${station.longname || "MAINZ"}`;

      // 24h holen, dann lokal auf letzte N Punkte begrenzen
      const startIso = new Date(Date.now()-24*3600*1000).toISOString();
      const ms = await j(`${BASE}/stations/${UUID}/W/measurements.json?start=${encodeURIComponent(startIso)}`);
      if(!Array.isArray(ms) || ms.length === 0) throw new Error("Keine Messwerte (24 h).");

      const points = ms
        .filter(m => m.value != null && m.timestamp)
        .map(m => ({ t: Date.parse(m.timestamp), v: Number(m.value) }))
        .sort((a,b)=>a.t-b.t);

      const last = points[points.length-1];
      elValue.textContent = Math.round(last.v);
      elCurr.textContent  = `Zuletzt gemessen: ${fmtDateTime(last.t)}`;

      // nur letzte N Punkte für Tendenz
      const ptsN = points.slice(-LAST_N);
      const s = slopePerHour(ptsN); // cm/h aus letzten N Messungen
      const t = trendIcon(s);

      elTrend.innerHTML = `
        <span class="label">Tendenz:</span>
        <svg viewBox="0 0 28 28" aria-hidden="true" style="color:${t.color}">${t.svg}</svg>
        <span style="color:${t.color};font-weight:800">${t.name}</span>
      `;
      elTrend.setAttribute("title", `Tendenz (aus den letzten ${LAST_N} Messungen): ${t.name}`);

    }catch(err){
      elErr.textContent = "Fehler: " + (err.message || err);
    }
  }

  load();
  setInterval(load, 60*1000);
</script>
</body>
</html>

